name: Changeset Agent

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  generate-changeset:
    # Only run if PR was merged (not just closed) and is NOT a release PR
    if: github.event.pull_request.merged == true && !startsWith(github.event.pull_request.head.ref, 'release/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # Need full history to analyze commits

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Build agent-worker
        working-directory: packages/agent-worker
        run: bun run build

      - name: Configure git
        run: |
          git config --global user.name "Changeset Bot"
          git config --global user.email "changeset-bot@users.noreply.github.com"

      - name: Run changeset generation workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -e  # Exit on error
          bun packages/agent-worker/src/cli/index.ts run .workflows/agent-changeset.yaml || {
            echo "âŒ Changeset generation failed"
            exit 1
          }

      - name: Summary
        run: |
          echo "### Changeset Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Analyzed PR #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Title: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "- Author: @${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above to see if a changeset PR was created." >> $GITHUB_STEP_SUMMARY
