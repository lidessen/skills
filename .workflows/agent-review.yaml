agents:
  reviewer:
    model: deepseek:deepseek-chat
    system_prompt: |
      You are a precise code reviewer. You analyze diffs and produce structured JSON output.
      Focus on: bugs, security issues, logic errors, bad patterns, and notable improvements.
      Be constructive. Reference specific files and line numbers.

context:
  provider: memory

setup:
  - shell: echo "$PR_NUMBER"
    as: pr_number

  - shell: echo "$GITHUB_REPOSITORY"
    as: repo

  # Write PR metadata to file (avoids context overflow)
  - shell: |
      gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" \
        --json title,body,baseRefName,headRefName,author,additions,deletions,changedFiles \
        > /tmp/pr-info.json
      echo "/tmp/pr-info.json"
    as: pr_info_file

  - shell: gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json files --jq '.files[].path'
    as: changed_files

  # Write the appropriate diff to file
  # Incremental: only changes between BEFORE_SHA and AFTER_SHA
  # Initial: full PR diff
  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        gh api "repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA" \
          -H "Accept: application/vnd.github.v3.diff" > /tmp/review-diff.txt 2>/dev/null || true
        echo "incremental"
      else
        gh pr diff "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" > /tmp/review-diff.txt 2>/dev/null || true
        echo "initial"
      fi
    as: review_type

  # New commits list (incremental only, for context)
  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        gh api "repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA" \
          --jq '.commits[] | "- `\(.sha[0:7])` \(.commit.message | split("\n")[0])"' 2>/dev/null || echo ""
      else
        echo ""
      fi
    as: new_commits

kickoff: |
  @reviewer Review PR #${{ pr_number }} in ${{ repo }}.

  ## Review Type: ${{ review_type }}

  ## Changed Files
  ```
  ${{ changed_files }}
  ```

  ## New Commits
  ```
  ${{ new_commits }}
  ```

  ## Instructions

  1. Read the PR metadata:
     ```bash
     cat ${{ pr_info_file }} | jq .
     ```

  2. Read the diff to review:
     ```bash
     cat /tmp/review-diff.txt
     ```

  3. If the diff is large, read specific files:
     ```bash
     # View a specific file's changes from the diff
     grep -A 100 "^diff --git a/path/to/file" /tmp/review-diff.txt
     ```

  4. Write your analysis as JSON to `/tmp/review-result.json`:
     ```bash
     cat > /tmp/review-result.json << 'REVIEW_EOF'
     {
       "summary": "Brief overview of the changes and their quality",
       "issues": [
         {
           "severity": "error|warning|suggestion",
           "file": "path/to/file.ts",
           "line": 42,
           "message": "Description of the issue"
         }
       ],
       "highlights": [
         "Positive things worth mentioning"
       ]
     }
     REVIEW_EOF
     ```

  Severity guide:
  - **error**: bugs, security issues, broken logic, data loss risks
  - **warning**: potential problems, bad patterns, missing edge cases
  - **suggestion**: style improvements, readability, minor optimizations

  Rules:
  - If no issues found, use `"issues": []`
  - Always include file paths and line numbers for issues
  - For incremental reviews, focus ONLY on the new changes in the diff
  - Be specific and actionable — vague feedback is not helpful
  - The JSON must be valid — the CI will parse it to post the review
