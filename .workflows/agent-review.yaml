agents:
  reviewer:
    model: deepseek:deepseek-chat
    system_prompt: prompts/reviewer.md

context:
  provider: memory

# Configuration (can be overridden via environment variables)
config:
  # Maximum number of commits to show in incremental reviews
  max_commits_display: ${MAX_COMMITS_DISPLAY:-10}
  # Review focus: 'incremental' (new changes only) or 'full' (always review all changes)
  review_mode: ${REVIEW_MODE:-incremental}

setup:
  - shell: gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json title,body,baseRefName,headRefName,author,additions,deletions,changedFiles
    as: pr_info

  - shell: gh pr diff "$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
    as: pr_diff

  - shell: gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json files --jq '.files[].path'
    as: changed_files

  # Find existing review comment or create new one
  - shell: |
      EXISTING=$(gh api repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments \
        --jq '.[] | select(.body | startswith("<!-- agent-review -->")) | .id' | head -1)

      if [ -n "$EXISTING" ]; then
        echo "$EXISTING"
      else
        gh api repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments \
          -f body='<!-- agent-review -->
      > â³ **Reviewing...**' --jq '.id'
      fi
    as: comment_id

  # Determine review type and get existing content if incremental
  - shell: |
      COMMENT_BODY=$(gh api repos/$GITHUB_REPOSITORY/issues/comments/${{ comment_id }} --jq '.body')

      # Check if this is an incremental review (comment already has review content)
      if echo "$COMMENT_BODY" | grep -q "## Summary\|## Issues Found"; then
        echo "incremental"
      else
        echo "initial"
      fi
    as: review_type

  # Extract and format commit info for incremental reviews
  - shell: |
      if [ "${{ review_type }}" = "incremental" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        # Format commits as markdown list
        gh api repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA \
          --jq '.commits[] | "- `\(.sha[0:7])` \(.commit.message | split("\n")[0])"'
      else
        echo ""
      fi
    as: formatted_commits

  # Calculate file statistics
  - shell: |
      FILES_COUNT=$(echo "${{ changed_files }}" | wc -l)

      # Get additions/deletions from PR info
      gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" \
        --json additions,deletions \
        --jq '"Files: \(.additions + .deletions) lines in " + (env.FILES_COUNT // "0") + " files (+\(.additions)/-\(.deletions))"'
    as: file_stats

  # Get diff based on review type
  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        # Incremental review: get diff between before and after SHAs
        echo "Incremental review: $BEFORE_SHA...$AFTER_SHA"

        # Get commit messages for context
        echo "## New Commits:"
        gh api repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA \
          --jq '.commits[] | "- \(.sha[0:7]) \(.commit.message | split("\n")[0])"'

        echo -e "\n## Incremental Changes:"
        # Get the actual diff for new commits
        gh api repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA \
          --jq '.files[] | "diff --git a/\(.filename) b/\(.filename)\n\(.patch // "")"'
      else
        # Initial review or manual trigger: check all changes
        echo "Full review - all PR changes"
        gh pr diff "$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
      fi
    as: review_diff

kickoff: |
  @reviewer Review the following code changes and provide actionable feedback.

  **Review Type**: ${{ review_type == 'incremental' && 'Incremental (new commits)' || 'Initial (full review)' }}

  ${{ review_type == 'incremental' && '## New Commits\n' + formatted_commits || '' }}

  ## Changed Files
  ${{ changed_files }}

  ## Code Changes
  ${{ review_diff }}

  **Your Task**:
  - Analyze code quality, potential bugs, and best practices
  - Provide specific feedback with file:line references
  - Be constructive and actionable

  Write your analysis to /tmp/review-content.md with:
  - **Summary**: Brief overview
  - **Issues Found**: List with severity and locations
  - **Good Practices**: Positive highlights (if any)

  Then run this script to format and post the review:
  ```bash
  # Generate timestamp
  TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")

  # Read agent's analysis
  REVIEW_CONTENT=$(cat /tmp/review-content.md)

  # Build the review based on type
  if [ "${{ review_type }}" = "initial" ]; then
    cat > /tmp/review.md << EOF
  <!-- agent-review -->
  ðŸ¤– **Automated Code Review** â€¢ Initial Review
  *Generated by agent-worker â€¢ [View workflow](https://github.com/$GITHUB_REPOSITORY/blob/main/.workflows/agent-review.yaml)*

  ---

  $REVIEW_CONTENT

  ---
  <details>
  <summary>ðŸ“‹ Review Details</summary>

  - **Timestamp**: $TIMESTAMP
  - **Stats**: ${{ file_stats }}
  - **Type**: Full review

  </details>
  EOF
  else
    # For incremental: append to existing comment
    EXISTING_BODY=$(gh api repos/$GITHUB_REPOSITORY/issues/comments/${{ comment_id }} --jq '.body')

    cat > /tmp/review.md << EOF
  $EXISTING_BODY

  ---

  ## ðŸ”„ Incremental Review ($TIMESTAMP)

  $REVIEW_CONTENT

  <details>
  <summary>ðŸ“‹ Review Details</summary>

  - **Timestamp**: $TIMESTAMP
  - **Stats**: ${{ file_stats }}
  - **Type**: Incremental (new commits only)

  </details>
  EOF
  fi

  # Update the comment
  gh api repos/$GITHUB_REPOSITORY/issues/comments/${{ comment_id }} \
    -X PATCH -F body=@/tmp/review.md
  ```
