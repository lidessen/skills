agents:
  reviewer:
    model: deepseek:deepseek-chat
    system_prompt: prompts/reviewer.md

context:
  provider: memory

# Configuration (can be overridden via environment variables)
config:
  # Maximum number of commits to show in incremental reviews
  max_commits_display: ${MAX_COMMITS_DISPLAY:-10}
  # Review focus: 'incremental' (new changes only) or 'full' (always review all changes)
  review_mode: ${REVIEW_MODE:-incremental}

setup:
  - shell: gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json title,body,baseRefName,headRefName,author,additions,deletions,changedFiles
    as: pr_info

  # DON'T load pr_diff here - it's too large and causes context overflow
  # Agent will fetch diffs on-demand using gh pr diff commands

  - shell: gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json files --jq '.files[].path'
    as: changed_files

  # Find existing review comment or create new one
  - shell: |
      set -e  # Exit on error

      EXISTING=$(gh api repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments \
        --jq '.[] | select(.body | startswith("<!-- agent-review -->")) | .id' 2>/dev/null | head -1 || true)

      if [ -n "$EXISTING" ]; then
        echo "$EXISTING"
      else
        gh api repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments \
          -f body='<!-- agent-review -->
      > â³ **Reviewing...**' --jq '.id' 2>&1 || echo ""
      fi
    as: comment_id

  # Determine review type based on GitHub trigger (more reliable than content parsing)
  - shell: |
      # synchronize = new commits pushed to existing PR = incremental
      # opened/reopened = initial review
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        echo "incremental"
      else
        echo "initial"
      fi
    as: review_type

  # Extract and format commit info for incremental reviews
  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        # Format commits as markdown list
        gh api repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA \
          --jq '.commits[] | "- `\(.sha[0:7])` \(.commit.message | split("\n")[0])"' 2>/dev/null || echo ""
      else
        echo ""
      fi
    as: formatted_commits

  # Calculate file statistics
  - shell: |
      # Get all stats in one call
      gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" \
        --json additions,deletions,changedFiles \
        --jq '"+\(.additions)/-\(.deletions) in \(.changedFiles) files"'
    as: file_stats

  # Get commit range for incremental reviews
  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        echo "$BEFORE_SHA...$AFTER_SHA"
      else
        echo ""
      fi
    as: commit_range

kickoff: |
  @reviewer Review code changes for PR #$PR_NUMBER in repository $GITHUB_REPOSITORY.

  ## PR Info
  ```json
  ${{ pr_info }}
  ```

  ## Changed Files
  ```
  ${{ changed_files }}
  ```

  ## How to Review

  **Use Bash tool to view diffs as needed**:

  ```bash
  # View full PR diff
  gh pr diff $PR_NUMBER --repo $GITHUB_REPOSITORY

  # View specific file diff
  gh pr diff $PR_NUMBER --repo $GITHUB_REPOSITORY -- path/to/file.ts
  ```

  **Your Task**:
  1. Use Bash tool to view relevant diffs (you'll see full context, not truncated)
  2. Analyze code quality, potential bugs, and best practices
  3. Provide specific feedback with file:line references
  4. Be constructive and actionable

  Write your analysis to /tmp/review-content.md with:
  - **Summary**: Brief overview
  - **Issues Found**: List with severity and locations
  - **Good Practices**: Positive highlights (if any)

  Then run this script to format and post the review:
  ```bash
  # Generate timestamp
  TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")

  # Get file stats
  FILE_STATS=$(gh pr view $PR_NUMBER --repo $GITHUB_REPOSITORY --json additions,deletions,changedFiles --jq '"+\(.additions)/-\(.deletions) in \(.changedFiles) files"')

  # Build review comment (avoid sed with multiline content)
  {
    echo '<!-- agent-review -->'
    echo 'ðŸ¤– **Automated Code Review**'
    echo "*Generated by agent-worker for PR #$PR_NUMBER â€¢ [View workflow](https://github.com/$GITHUB_REPOSITORY/blob/main/.workflows/agent-review.yaml)*"
    echo ''
    echo '---'
    echo ''
    cat /tmp/review-content.md
    echo ''
    echo '---'
    echo '<details>'
    echo '<summary>ðŸ“‹ Review Details</summary>'
    echo ''
    echo "- **PR**: #$PR_NUMBER"
    echo "- **Timestamp**: $TIMESTAMP"
    echo "- **Stats**: $FILE_STATS"
    echo ''
    echo '</details>'
  } > /tmp/review.md

  # Post or update the comment
  COMMENT_ID="${{ comment_id }}"
  if [ -n "$COMMENT_ID" ] && [ "$COMMENT_ID" != "" ]; then
    gh api repos/$GITHUB_REPOSITORY/issues/comments/$COMMENT_ID \
      -X PATCH -F body=@/tmp/review.md
  else
    gh pr comment $PR_NUMBER --repo $GITHUB_REPOSITORY --body-file /tmp/review.md
  fi
  ```
