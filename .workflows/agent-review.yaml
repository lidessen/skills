agents:
  reviewer:
    model: deepseek:deepseek-chat
    system_prompt: prompts/reviewer.md

context:
  provider: memory

# Configuration (can be overridden via environment variables)
config:
  # Maximum number of commits to show in incremental reviews
  max_commits_display: ${MAX_COMMITS_DISPLAY:-10}
  # Review focus: 'incremental' (new changes only) or 'full' (always review all changes)
  review_mode: ${REVIEW_MODE:-incremental}

setup:
  - shell: gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json title,body,baseRefName,headRefName,author,additions,deletions,changedFiles
    as: pr_info

  - shell: gh pr diff "$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
    as: pr_diff

  - shell: gh pr view "$PR_NUMBER" --repo "$GITHUB_REPOSITORY" --json files --jq '.files[].path'
    as: changed_files

  # Find existing review comment or create new one
  - shell: |
      EXISTING=$(gh api repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments \
        --jq '.[] | select(.body | startswith("<!-- agent-review -->")) | .id' | head -1)

      if [ -n "$EXISTING" ]; then
        echo "$EXISTING"
      else
        gh api repos/$GITHUB_REPOSITORY/issues/$PR_NUMBER/comments \
          -f body='<!-- agent-review -->
      > ‚è≥ **Reviewing...**' --jq '.id'
      fi
    as: comment_id

  # Get diff based on review type
  - shell: |
      if [ "$TRIGGER_TYPE" = "synchronize" ] && [ -n "$BEFORE_SHA" ] && [ -n "$AFTER_SHA" ]; then
        # Incremental review: get diff between before and after SHAs
        echo "Incremental review: $BEFORE_SHA...$AFTER_SHA"

        # Get commit messages for context
        echo "## New Commits:"
        gh api repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA \
          --jq '.commits[] | "- \(.sha[0:7]) \(.commit.message | split("\n")[0])"'

        echo -e "\n## Incremental Changes:"
        # Get the actual diff for new commits
        gh api repos/$GITHUB_REPOSITORY/compare/$BEFORE_SHA...$AFTER_SHA \
          --jq '.files[] | "diff --git a/\(.filename) b/\(.filename)\n\(.patch // "")"'
      else
        # Initial review or manual trigger: check all changes
        echo "Full review - all PR changes"
        gh pr diff "$PR_NUMBER" --repo "$GITHUB_REPOSITORY"
      fi
    as: review_diff

kickoff: |
  @reviewer Please review this pull request.

  **Review Type**: ${{ env.TRIGGER_TYPE == 'synchronize' && env.BEFORE_SHA != '' && 'Incremental (new commits only)' || 'Full (all changes)' }}

  ## PR Info
  ${{ pr_info }}

  ## Changed Files
  ${{ changed_files }}

  ## Changes to Review
  ${{ review_diff }}

  When done, write your review to /tmp/review.md with the following format:

  ```markdown
  <!-- agent-review -->
  ü§ñ **Automated Code Review**
  *Generated by agent-worker ‚Ä¢ [View workflow](https://github.com/$GITHUB_REPOSITORY/blob/main/.workflows/agent-review.yaml)*

  ---

  [Your review content here...]

  For incremental reviews, note which commits were reviewed.
  Provide clear, actionable feedback.
  ```

  Then update the review comment:
  ```
  gh api repos/$GITHUB_REPOSITORY/issues/comments/${{ comment_id }} \
    -X PATCH -F body=@/tmp/review.md
  ```
